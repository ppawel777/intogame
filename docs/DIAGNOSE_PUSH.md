# Диагностика проблемы с push-уведомлениями

## Текущая ситуация

Ответ API: `{"success":true,"sent":0,"failed":1,"total":1}`

Это означает, что уведомление не было отправлено. Нужно проверить логи бекенда.

## Шаг 1: Проверка логов бекенда

На сервере выполни:

```bash
docker logs -n 100 frontend-deploy-backend-1 | grep -i push
```

Или все логи:

```bash
docker logs -n 200 frontend-deploy-backend-1
```

Ищи строки с:
- `Ошибка отправки уведомления пользователю`
- `Подписка недействительна`
- Коды ошибок (410, 400, 401, 413)

## Шаг 2: Запуск скрипта диагностики

На сервере:

```bash
cd ~/frontend-deploy/backend
node scripts/diagnose-push.js 9
```

Скрипт покажет детали ошибки для каждой подписки.

## Шаг 3: Проверка подписки в БД

Выполни в Supabase SQL Editor:

```sql
SELECT 
  id,
  user_id,
  endpoint,
  created_at,
  updated_at
FROM push_subscriptions
WHERE user_id = 9;
```

Проверь:
- Endpoint не пустой
- Подписка не слишком старая (может быть недействительна)

## Шаг 4: Типичные ошибки и решения

### Ошибка 410 (Gone) - Подписка недействительна

**Причина:** Подписка устарела или была отозвана браузером.

**Решение:**
1. Удали подписку из БД:
```sql
DELETE FROM push_subscriptions WHERE user_id = 9;
```

2. Попроси пользователя заново включить уведомления в профиле

### Ошибка 400 (Bad Request) - Неверный запрос

**Причина:** Неверный формат подписки или payload.

**Решение:**
- Проверь, что VAPID ключи правильные
- Проверь формат данных в БД (p256dh, auth должны быть валидными base64)

### Ошибка 401 (Unauthorized) - Неавторизован

**Причина:** Неверные VAPID ключи.

**Решение:**
1. Проверь `.env` бекенда:
```bash
cd ~/frontend-deploy/backend
cat .env | grep VAPID
```

2. Убедись, что ключи правильные и не перепутаны (public/private)

3. Перезапусти бекенд:
```bash
cd ~/frontend-deploy
docker compose restart backend
```

### Ошибка 413 (Payload Too Large) - Payload слишком большой

**Причина:** Данные в уведомлении слишком большие.

**Решение:**
- Уменьши размер `data` в запросе
- Максимальный размер payload для FCM: 4KB

## Шаг 5: Проверка VAPID ключей

```bash
# Проверь, что публичный ключ доступен
curl https://intogame.ru/api/push/vapid-public-key

# Должен вернуться JSON с publicKey
```

## Шаг 6: Проверка подписки на клиенте

На iPhone:
1. Открой PWA (установленное приложение)
2. Перейди в профиль
3. Выключи и включи push-уведомления заново
4. Проверь, что подписка обновилась в БД

## Шаг 7: Особенности iOS

**Важно:** На iOS push-уведомления в PWA работают только если:
- iOS 16.4 или новее
- PWA установлен на главный экран (не открыт в Safari)
- Разрешение на уведомления выдано

Если endpoint содержит `fcm.googleapis.com`, это может быть проблема - iOS может требовать APNs endpoint для установленных PWA.

## Следующие шаги

1. Выполни проверку логов (Шаг 1)
2. Запусти скрипт диагностики (Шаг 2)
3. Пришли результаты - помогу разобраться

