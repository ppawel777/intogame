# Настройка PWA на фронтенде

## Описание

Приложение настроено как Progressive Web App (PWA) с поддержкой:

- Установки на домашний экран
- Офлайн-режима
- Push-уведомлений
- Автоматических обновлений

## Шаг 1: Установка зависимостей

```bash
cd frontend
npm install
```

Это установит:

- `vite-plugin-pwa` - плагин для PWA
- `workbox-window` - библиотека для работы с Service Worker

## Шаг 2: Создание иконок

Для PWA **обязательно** нужны иконки следующих размеров (согласно спецификации Web App Manifest):

- `icon-192x192.png` (192x192px) - минимальный размер для Android и браузеров
- `icon-512x512.png` (512x512px) - используется для splash screen и больших экранов
- `favicon.ico` (32x32px или 16x16px) - для вкладки браузера

**Почему именно эти размеры?**

- **192x192** и **512x512** - это стандартные размеры, требуемые спецификацией Web App Manifest для PWA
- **192x192** - минимальный размер для Android и отображения в браузерах
- **512x512** - используется для splash screen при установке PWA и больших экранов

**Если генератор предлагает другие размеры (180x180, 256x256):**

- Можно использовать их, но тогда нужно:
  1. Переименовать файлы: `icon-180x180.png` → `icon-192x192.png`, `icon-256x256.png` → `icon-512x512.png`
  2. Или обновить конфигурацию в `vite.config.ts`, раскомментировав опциональные размеры
- Рекомендуется всё же создать именно 192x192 и 512x512 для полной совместимости со спецификацией

### Вариант 1: Использовать существующую иконку

Если у тебя есть логотип приложения, создай иконки:

1. Открой логотип в графическом редакторе
2. Создай квадратные версии (192x192 и 512x512)
3. Сохрани в `frontend/public/`:
   - `icon-192x192.png`
   - `icon-512x512.png`
   - `favicon.ico`

### Вариант 2: Временные иконки

Можно использовать любые квадратные изображения для тестирования.

### Вариант 3: Онлайн-генератор

Используй сервисы типа:

- https://realfavicongenerator.net/
- https://www.pwabuilder.com/imageGenerator

## Шаг 3: Настройка переменных окружения

Убедись, что в `.env` файле указан URL бекенда:

```env
VITE_API_BASE_URL=http://localhost:3000
# или для production:
# VITE_API_BASE_URL=https://intogame.ru
```

## Шаг 4: Сборка и проверка

### Development режим

```bash
npm run dev
```

PWA будет работать в dev режиме (благодаря `devOptions.enabled: true`).

### Production сборка

```bash
npm run build
```

После сборки проверь папку `build/`:

- Должен быть `manifest.webmanifest`
- Должен быть Service Worker файл

## Шаг 5: Тестирование PWA

### В браузере

1. Открой приложение в Chrome/Edge
2. Открой DevTools (F12) → Application → Service Workers
3. Проверь, что Service Worker зарегистрирован
4. Проверь Manifest → должен отображаться корректно

### Установка на устройство

1. Открой приложение на мобильном устройстве
2. В браузере выбери "Добавить на главный экран"
3. Приложение установится как PWA

### Тестирование push-уведомлений

1. Войди в приложение
2. Перейди в Профиль
3. Включи переключатель "Push-уведомления"
4. Разреши уведомления в браузере
5. Проверь, что подписка сохранена

## Структура файлов

```
frontend/
├── public/
│   ├── icon-192x192.png      # Иконка 192x192
│   ├── icon-512x512.png      # Иконка 512x512
│   ├── favicon.ico           # Favicon
│   └── sw.js                 # Service Worker (генерируется автоматически)
├── src/
│   ├── components/
│   │   └── PushNotificationManager/  # Компонент управления уведомлениями
│   ├── utils/
│   │   ├── pushNotifications.ts      # Утилиты для работы с push
│   │   └── registerServiceWorker.ts  # Регистрация SW
│   └── pages/
│       └── Profile/
│           └── ProfilePage.tsx        # Интегрирован компонент уведомлений
└── vite.config.ts            # Конфигурация PWA
```

## Компоненты

### PushNotificationManager

Компонент для управления push-уведомлениями. Отображается в профиле пользователя.

**Функции:**

- Включение/выключение уведомлений
- Проверка разрешений браузера
- Автоматическая регистрация подписки

### Утилиты

**`pushNotifications.ts`** - основные функции:

- `registerPushNotifications()` - полная регистрация
- `requestNotificationPermission()` - запрос разрешения
- `subscribeToPush()` - создание подписки
- `sendSubscriptionToServer()` - отправка на сервер

## Интеграция с событиями приложения

Для отправки уведомлений используй API бекенда:

```typescript
// Пример: уведомление о новой игре
await fetch(`${API_BASE_URL}/api/push/send`, {
   method: 'POST',
   headers: { 'Content-Type': 'application/json' },
   body: JSON.stringify({
      userIds: [123, 456],
      title: 'Новая игра!',
      body: `Создана игра на ${gameDate}`,
      url: `/games/${gameId}`,
      data: { gameId },
   }),
})
```

## Troubleshooting

### Service Worker не регистрируется

1. Проверь консоль браузера на ошибки
2. Убедись, что приложение работает по HTTPS (или localhost)
3. Проверь, что `vite-plugin-pwa` установлен

### Push-уведомления не работают

1. Проверь, что VAPID keys настроены на бекенде
2. Убедись, что разрешение на уведомления получено
3. Проверь логи бекенда при регистрации подписки
4. Убедись, что подписка сохранена в БД

### Иконки не отображаются

1. Проверь, что файлы находятся в `public/`
2. Убедись, что пути в `vite.config.ts` правильные
3. Очисти кэш браузера

### PWA не устанавливается

1. Убедись, что manifest.webmanifest генерируется
2. Проверь, что все обязательные поля заполнены
3. Убедись, что приложение работает по HTTPS (или localhost)

## Следующие шаги

1. Создать реальные иконки приложения
2. Настроить отправку уведомлений для событий:
   - Создание новой игры
   - Изменение статуса игры
   - Напоминания о предстоящих играх
   - Новые сообщения в чате
3. Добавить офлайн-страницу
4. Оптимизировать кэширование
