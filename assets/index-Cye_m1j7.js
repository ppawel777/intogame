import{r as e,j as a,p as s,J as t,K as i,P as l,Q as r,T as n,s as o,U as c,V as d,t as m,b as h,d as x,B as u,v as g,w as j,x as p,y as _,z as f,W as y,q as b,F as v,X as w,Y as C,Z as k,h as S,$ as q,a0 as z,a1 as V}from"./vendor-CGLmNOaL.js";import{s as F,g as E}from"./index-CQZqdVJm.js";const I="HH:mm",M="YYYY-MM-DD",T=({form:c,initialValues:d,isCreate:m=!1})=>{const[h,x]=e.useState([]),[u,g]=e.useState(!1);e.useEffect((()=>{(async()=>{g(!0);try{const{data:e,error:a}=await F.from("places").select("*").eq("is_active",!0);if(a)throw a;const s=e.map((e=>({value:e.id,label:e.name})));e.length&&x(s)}catch(e){o.error(e.message)}finally{g(!1)}})()}),[]);return a.jsxs(s,{colon:!1,labelAlign:"left",labelCol:{span:4},wrapperCol:{span:10},form:c,name:"create_game",initialValues:d,children:[a.jsx(s.Item,{name:"place_id",label:"Площадка",children:a.jsx(t,{options:h,loading:u})}),a.jsx(s.Item,{name:"game_date",label:"Дата проведения",children:a.jsx(i,{placeholder:"Выберите дату",format:M,disabledDate:e=>{const a=l().format(M);return e&&e<l(a,M)}})}),a.jsx(s.Item,{name:"game_time",label:"Время проведения",children:a.jsx(r.RangePicker,{format:I})}),a.jsx(s.Item,{name:"game_price",label:"Цена игры, руб.",children:a.jsx(n,{})}),a.jsx(s.Item,{name:"players_limit",label:"Допустимое число игроков",children:a.jsx(n,{})}),!m&&a.jsx(s.Item,{name:"is_active",label:"Статус игры",children:a.jsx(t,{options:[{label:"Активна",value:!0},{label:"Закрыта",value:!1}]})})]})},N=({handleChangeVisibleModal:e,setChangeGame:t})=>{const[i]=s.useForm();return a.jsx(c,{title:"Создать игру",open:!0,destroyOnClose:!0,maskClosable:!1,onOk:()=>{i.submit(),i.validateFields().then((a=>{(async a=>{try{const{data:s,error:i}=await F.from("games").insert([a]).select();if(i)throw i;s&&o.success("Игра добавлена"),t(!0),e(!1)}catch(s){o.error(s.message)}})(a)})).catch((e=>{e.errorFields.forEach((e=>{o.error({content:e.name[0]+": "+e.errors[0],duration:6})}))}))},okText:"Создать",onCancel:()=>e(!1),cancelText:"Закрыть",width:"80vw",style:{top:20},children:a.jsx(T,{form:i,initialValues:{place_id:null,game_date:null,game_time:null,game_price:null,players_limit:null},isCreate:!0})})},D=({gamesData:e,id:t,handleChangeVisibleModal:i,setChangeGame:r})=>{const[n]=s.useForm(),d=e.find((e=>e.id===t)),[m,h]=d.game_time,x={place_id:d.place_id,game_date:l(d.game_date),game_time:[l(m),l(h)],game_price:d.game_price,players_limit:d.players_limit,is_active:d.is_active};return a.jsx(c,{title:"Редактировать игру",open:!0,destroyOnClose:!0,maskClosable:!1,onOk:()=>{n.submit(),n.validateFields().then((e=>{(async e=>{try{const{data:a,error:s}=await F.from("games").update(e).eq("id",t).select();if(s)throw s;a&&o.success("Игра обновлена"),r(!0),i(!1,0)}catch(a){o.error(a.message)}})(e)})).catch((e=>{e.errorFields.forEach((e=>{o.error({content:e.name[0]+": "+e.errors[0],duration:6})}))}))},okText:"Сохранить",onCancel:()=>i(!1,0),cancelText:"Закрыть",width:"80vw",style:{top:20},children:a.jsx(T,{form:n,initialValues:x})})},G=({id:s,handleChangeVisibleModal:t})=>{const[i,l]=e.useState(!0),[r,n]=e.useState([]);e.useEffect((()=>{(async()=>{l(!0);try{const{data:e,error:a}=await F.from("view_users_from_game").select("*").eq("game_id",s);if(console.log("data",e),a)throw a;e.length&&n(e)}catch(e){o.error(e.message)}finally{l(!1)}})()}),[s]);const c=({icon:e,text:s})=>a.jsxs(_,{children:[f.createElement(e),s]});return a.jsx(d,{closable:!0,destroyOnClose:!0,title:a.jsx("p",{children:"Список игроков"}),placement:"right",open:!0,loading:i,onClose:()=>t(!1,0),width:"40%",children:a.jsx(m,{loading:i,itemLayout:"horizontal",dataSource:r,renderItem:e=>a.jsx(m.Item,{actions:[a.jsx(c,{icon:g,text:"156"},"list-vertical-star-o"),a.jsx(c,{icon:j,text:"156"},"list-vertical-like-o"),a.jsx(c,{icon:p,text:"2"},"list-vertical-message")],extra:a.jsx(u,{children:"Связаться"}),children:a.jsx(m.Item.Meta,{avatar:a.jsx(h,{src:e.avatar_url,style:{backgroundColor:"#87d068"},icon:a.jsx(x,{})}),title:e.user_name,description:"Описание"})})})})},O="_wrapReserved_1kszq_1",Y="_cardWrap_1kszq_8",B="_editGameBtn_1kszq_13",P="_extraSuccess_1kszq_19",W="_extraFull_1kszq_24",$="_extraClose_1kszq_29",A=({isArchive:s=!1})=>{const[t,i]=e.useState(!1),[r,n]=e.useState({visible:!1,id:0}),[c,d]=e.useState({visible:!1,id:0}),[m,h]=e.useState(!1),[x,g]=e.useState(!0),[j,p]=e.useState([]),[f,T]=e.useState(!1),[A,H]=e.useState(null),[R,J]=e.useState(null);e.useEffect((()=>{(async()=>{g(!0);const e=E("user_id");try{const{data:a,error:s}=await F.from("users").select("*").eq("uuid",e).single();if(s)throw s;H(a.id)}catch(a){o.error(a.message)}finally{g(!1)}})()}),[]),e.useEffect((()=>{if(!A)return;(async()=>{g(!0);try{const{data:e,error:a}=await F.from("votes").select("*").eq("user_id",A).single();if(a)throw a;J(e)}catch(e){o.error(e.message)}finally{g(!1)}})()}),[A]);const K=async()=>{g(!0);try{const{data:e,error:a}=await F.from("view_games").select("*").eq("is_active",!s);if(a)throw a;e.length&&p(e)}catch(e){o.error(e.message)}finally{g(!1)}};e.useEffect((()=>{K()}),[s]),e.useEffect((()=>{m&&(K(),h(!1))}),[m]);const L=e=>i(e),Q=(e,a)=>n({visible:e,id:a}),U=(e,a)=>d({visible:e,id:a}),X=e=>{T(!1),(async e=>{g(!0);try{const a={game_id:e,user_id:A},{error:s}=await F.from("votes").insert(a);if(s)throw s;h(!0)}catch(a){o.error(a.message)}finally{g(!1)}})(e)},Z=e=>{T(!1),(async e=>{g(!0);try{const{error:a}=await F.from("votes").delete().eq("game_id",e).eq("user_id",A);if(a)throw a;h(!0)}catch(a){o.error(a.message)}finally{g(!1)}})(e)},ee=({id:e,total:t,limit:i})=>a.jsx(a.Fragment,{children:s?a.jsx(z,{status:"default",text:a.jsx("span",{className:$,children:"Игра закрыта"})}):a.jsxs(a.Fragment,{children:[t===i?a.jsx(z,{status:"success",text:a.jsx("span",{className:W,children:"Нет мест"})}):a.jsx(z,{status:"success",text:a.jsx("span",{className:P,children:"Есть места"})}),a.jsx(V,{className:B,onClick:()=>Q(!0,e)})]})}),ae=({item:e})=>{const s=l(e.game_date).format(M),[t,i]=e.game_time;return a.jsx(k,{bordered:!0,items:[{key:"1",label:"Дата игры",children:s},{key:"2",label:"Время игры",children:`${l(t).format(I)} - ${l(i).format(I)}`},{key:"3",label:"Адрес площадки",children:e.place_address},{key:"3",label:"Лимит игроков",children:e.players_limit},{key:"3",label:"Проголосовало игроков",children:a.jsxs(v,{justify:"space-between",children:[a.jsx("span",{style:{fontWeight:600},children:e.votes_count}),e.votes_count>=1&&a.jsx(u,{onClick:()=>U(!0,e.id),children:"Список"})]})},{key:"4",label:"Цена",children:e.game_price},{key:"5",label:"Условия записи",children:a.jsxs(v,{justify:"space-between",children:[a.jsx("span",{children:"Оплата сразу"}),a.jsx(S,{style:{fontSize:"20px",cursor:"pointer"},title:"Узнать подробнее"})]})}],layout:"horizontal",column:1})},se=({item:e})=>{if(!s)return R?a.jsx(q,{title:"Отмена записи",description:"Подтвердите отмену записи",open:f,onConfirm:()=>Z(e.id),okButtonProps:{loading:x},onCancel:()=>T(!1),children:a.jsx(u,{onClick:()=>T(!0),style:{marginTop:"16px",width:"100%"},children:"Отменить запись"})}):a.jsx(q,{title:"Запись в игру",description:"Подтвердите свою запись",open:f,onConfirm:()=>X(e.id),okButtonProps:{loading:x},onCancel:()=>T(!1),children:a.jsx(u,{type:"primary",onClick:()=>T(!0),style:{marginTop:"16px",width:"100%"},disabled:e.players_total===e.players_limit,children:"Записаться"})})};return a.jsxs("div",{className:O,children:[s?null:a.jsxs(_,{size:"large",children:[a.jsx("h3",{children:"Ближайшие игры"}),a.jsx(u,{icon:a.jsx(y,{}),onClick:()=>L(!0),children:"Создать игру"})]}),x?a.jsx(b,{active:!0}):a.jsx(v,{gap:16,wrap:!0,className:Y,children:j.length?j.map((e=>a.jsxs(w,{title:e.place_name,extra:a.jsx(ee,{id:e.id,total:e.players_total,limit:e.players_limit}),style:{width:550},children:[a.jsx(ae,{item:e}),a.jsx(se,{item:e})]},e.id))):a.jsx(C,{description:"Нет предстоящих игр",style:{width:"100%"}})}),t&&a.jsx(N,{handleChangeVisibleModal:L,setChangeGame:h}),r.visible&&a.jsx(D,{gamesData:j,id:r.id,handleChangeVisibleModal:Q,setChangeGame:h}),c.visible&&a.jsx(G,{id:c.id,handleChangeVisibleModal:U})]})};export{A as default};
